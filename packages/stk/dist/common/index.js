import*as e from"lodash-es";import*as t from"mobx";import*as i from"fast-equals";class n{constructor(){this.tree=[],(0,t.makeAutoObservable)(this,null,{autoBind:!0})}init(e){let t=this.getRawTreeMap(e),{tree:i,tree_map:n,lost_tree:s}=this.getTree(e,t),{tree:r,lost_tree:h}=this.sortTree(i,n,s);return this.tree=r,h}find(e,t){let i=t||this.tree;for(let t=0;t<i.length;t++){let n=i[t];if(n.id===e)return n;if(n.children)return this.find(e,n.children)}}insert(e,t){let{target_level:i,cloned_item:n}=this.getDroppableItem(t),{active_item:s,effect_items:r}=this.place({type:"push",active_item:e,over_item:n,target_level:i});return{item:s,effect_items:r}}remove(e){let{cloned_item:t,effect_items:i}=this.take(e),n=[];return t?.children?.length&&(n=this.getherItems(t.children)),{id:t.id,remove_items:n,effect_items:i}}update(t,i){if(!t.length){let t=this.find(i.id);if(!t)return;Object.keys((0,e.omit)(i,"id")).forEach(e=>{t[e]=i[e]});return}let{item:n,target_level:s,target_index:r}=this.getItem(t),h={...n,...i};return s[r]=h,h}move(t){let{active_parent_index:i,over_parent_index:n,droppable:s}=t,{cloned_item:r}=this.getItem(i),{cloned_item:h,target_level:l}=s?this.getDroppableItem(n):this.getItem(n);if(h.next_id===r.id&&!s)return{effect_items:[]};let d=r.next_id===h.id&&!s,o=[],c=()=>{let{effect_items:t}=this.place({type:s?"push":"insert",active_item:r,over_item:h,target_level:l,over_index:(0,e.last)(n)});return t},a=()=>{let{effect_items:e}=this.take(i,d);return e};o=r.pid===h.pid?(0,e.last)(i)<(0,e.last)(n)?[c,a]:[a,c]:i.length>n.length?[a,c]:[c,a];let u=(0,e.flatten)(o.map(e=>e()));return{effect_items:this.getUniqEffectItems(u)}}getItem(i){let n=[],s=0,r=null,h=this.getIndexes(i),l=(0,e.initial)(h);return s=(0,e.last)(i),r=(0,e.get)(this.tree,h),n=l.length?(0,e.get)(this.tree,l):this.tree,{item:r,cloned_item:(0,t.toJS)(r),target_level:n,target_index:s}}getDroppableItem(i){if(!i.length)return{target_level:this.tree,cloned_item:null};let n=null,s=[];return s=1===i.length?i:this.getIndexes(i),(n=(0,e.get)(this.tree,s)).children||(n.children=[]),{target_level:n.children,cloned_item:(0,t.toJS)(n)}}getRawTreeMap(e){let t={};return e.map(e=>{t[e.id]=e}),t}getTree(e,t){let i=[],n=[];return e.forEach(e=>{let s=t[e.prev_id],r=t[e.next_id];e.prev_id===e.next_id||!t[e.id]||s&&s.prev_id===s.next_id||r&&r.prev_id===r.next_id?(e.prev_id=void 0,e.next_id=void 0,e.pid=void 0,t[e.id]=e,n.push(e)):e.pid?(t[e.pid].children||(t[e.pid].children=[]),t[e.pid]?.children?.length?t[e.pid].children.push(e):t[e.pid].children=[e]):i.push(e)}),{tree:i,tree_map:t,lost_tree:n}}sortTree(t,i,n){let s=[],r=(0,e.find)(t,e=>!e.prev_id);if(!r){if(n&&n.length){let e=this.sortLostTree(n,i);return{tree:e,lost_tree:e}}return{tree:[],lost_tree:[]}}let h=r.id;for(;h;){let e=i[h];e?.children?.length&&(e.children=this.sortTree(e.children,i).tree),s.push(e),h=e.next_id}if(n&&n.length){let e=this.sortLostTree(n,i);e[0].prev_id=s.at(-1).id,s.push(...e)}return{tree:s,lost_tree:n}}sortLostTree(e,t){return e.map((i,n)=>{let s=e.at(n+1);return s&&(i.next_id=s.id,s.prev_id=i.id,t[i.id]=i,t[s.id]=s),i})}take(e,i){let{cloned_item:n,target_level:s,target_index:r}=this.getItem(e),h=[];if(n.prev_id){let e=s[r-1];e.next_id=n.next_id??"",h.push((0,t.toJS)(e))}if(n.next_id){let e=s[r+1];e.prev_id=n.prev_id??"",i&&(e.next_id=n.id),h.push((0,t.toJS)(e))}return s.splice(r,1),{cloned_item:n,effect_items:h}}place(i){let{type:n,active_item:s,over_item:r,target_level:h,over_index:l}=i,d=[];if("push"===n){if(s.pid=r?r.id:"",h.length){let i=(0,e.last)(h);i.next_id=s.id,s.prev_id=i.id,d.push((0,t.toJS)(i))}else s.prev_id=void 0;s.next_id=void 0,d.push((0,t.toJS)(s)),h.push(s)}else{if(s.pid=r.pid,s.prev_id=r.id,s.next_id=r.next_id,r.next_id){let e=h[l+1];e.prev_id=s.id,d.push((0,t.toJS)(e))}else s.next_id=void 0;s.next_id===r.id?r.next_id=s.next_id:r.next_id=s.id,d.push((0,t.toJS)(s)),d.push((0,t.toJS)(r)),h.splice(l+1,0,s)}return{active_item:s,effect_items:d}}getUniqEffectItems(t){return(0,e.reduceRight)(t,(e,t)=>(e.some(e=>e.id===t.id)||e.unshift(t),e),[])}getIndexes(t){return(0,e.flatMap)(t,(e,i)=>i<t.length-1?[e,"children"]:[e])}getherItems(e){return e.reduce((e,t)=>(e.push(t),t?.children?.length&&e.push(...this.getherItems(t.children)),e),[])}}let s=n=>{let s=n.watch,r={},h={},l=[];return Object.keys(s).map(e=>{if(-1!==e.indexOf("|")){let t=e.split("|");l.push(...t.map(t=>({key:t,raw:e})))}-1!==e.indexOf(".")?r[e]=s[e]:h[e]=s[e]}),[...Object.keys(r).map(s=>(0,t.reaction)(()=>(0,e.get)(n,s),(e,n)=>{let h=(0,t.toJS)(e),l=(0,t.toJS)(n);(0,i.deepEqual)(h,l)||r[s](h,l)})),(0,t.observe)(n,r=>{let{name:h,newValue:d,oldValue:o}=r,c=l.find(e=>{if(e.key===h)return e});if(c){let t=c.raw.split("|");t.includes(h)&&s[c.raw](t.map(t=>(0,e.get)(n,t)))}if(s[h]){let e=(0,t.toJS)(d),n=(0,t.toJS)(o);(0,i.deepEqual)(e,n)||s[h](e,n)}})]},r=(t,i,n)=>{i.forEach(i=>{t.addEventListener(i,(0,e.debounce)(n,900,{leading:!0}))})},h=(t,i,n)=>{i.forEach(i=>{t.removeEventListener(i,(0,e.debounce)(n,900,{leading:!0}))})};class l{constructor(){this.config={context:null,events:["mousemove","scroll","keydown","mousedown","touchstart"],onIdle:null,onActive:null,onHide:null,onShow:null},this.time=6e4,this.idle=!1,this.visible=!0,this.timer=null,this.acts=[],this.watch={time:e=>{this.off(),e&&this.on()}},(0,t.makeAutoObservable)(this,{config:!1,timer:!1,acts:!1},{autoBind:!0}),this.acts=[...s(this)]}init(e,t){e&&(this.time=e,this.config=Object.assign(this.config,t),this.on())}on(){this.start(),r(window,this.config.events,this.active.bind(this.config.context??this)),(this.config.onShow||this.config.onHide)&&r(document,["visibilitychange"],this.changeVisible.bind(this.config.context??this))}off(){this.timer&&clearTimeout(this.timer),this.acts.map(e=>e()),h(window,this.config.events,this.active.bind(this.config.context??this)),(this.config.onShow||this.config.onHide)&&h(document,["visibilitychange"],this.changeVisible.bind(this.config.context??this))}start(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.idle=!0,this.config.onIdle&&this.config.onIdle.call(this.config.context??this)},this.time)}active(){this.idle&&(this.idle=!1,this.config.onActive&&this.config.onActive.call(this.config.context??this)),this.start()}changeVisible(){document.hidden?this.visible&&(this.visible=!1,this.config.onHide&&this.config.onHide.call(this.config.context??this)):!this.visible&&(this.visible=!0,this.config.onShow&&this.config.onShow.call(this.config.context??this))}}let d=(e,t)=>{let i={};return e.forEach(e=>{i[e[t]]=e}),Object.values(i)},o=e=>{e||(e=30);let t="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",i=new Uint8Array(e);window.crypto.getRandomValues(i);let n="";for(let s=0;s<e;s++)n+=t[i[s]%t.length];return n};export{n as DirTree,l as Idle,o as id,d as uniqBy};