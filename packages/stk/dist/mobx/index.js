import*as e from"mobx";import*as t from"fast-equals";import*as r from"lodash-es";let n=new WeakMap;function o(e,t,r){let o={ctx:this,fn:r},i=n.get(e);i||n.set(e,i=new Map);let l=i.get(t);l?l.push(o):i.set(t,[o])}function i(e,t,r){let n=this,i=(o,a)=>{l(e,t,i),r.call(n,o,a)};i.fn=r,o(e,t,i)}function l(e,t,r){if(void 0===t)return void n.set(e,new Map);let o=n.get(e);if(o){let e=o.get(t);if(e&&e.length>0){let n=[];r&&(n=e.filter(e=>e.fn!==r&&e.fn?.fn!==r)),o.set(t,n)}}}function a(e,t,...r){let o=n.get(e);if(o){let e=o.get(t);if(e){let[t,n]=r;e.forEach(e=>e.fn.call(e.ctx,t,n))}}}let f=Array.isArray,u=e=>"[object Date]"===p(e),s=e=>"string"==typeof e,c=e=>null!==e&&"object"==typeof e,y=e=>"string"==typeof e&&"NaN"!==e&&"-"!==e[0]&&""+parseInt(e,10)===e,p=e=>Object.prototype.toString.call(e),g=e=>p(e).slice(8,-1),d=(e,t)=>!Object.is(e,t);function w(e){try{return JSON.parse(e)}catch(t){return e}}let k=Object.prototype.hasOwnProperty,h=(e,t)=>k.call(e,t);function m(e){return(0,eval)(e)}let x=new WeakMap,S={storage:{},key:"",proxy:{}},v=!0;function b(e,t){return function(){delete e[t]}}function _(e,t,...r){let n=`${S.key}.${t}`;f(e)&&y(t)&&(n=`${S.key}[${t}]`),a(S.storage,n,...r)}let E=!1,O=function(){let e={};return["push","pop","shift","unshift","splice"].forEach(t=>{e[t]=function(...e){E=!0;let r=this.length,n=x.get(this)[t].apply(this,e);return this.length>r&&_(this,"length",this.length,r),E=!1,n}}),e}();function $(e,t,r){return f(e)&&h(O,t)?Reflect.get(O,t,r):Reflect.get(e,t,r)}function j(e){v=!1;let t=S.proxy.getExpires(S.key);S.proxy[S.key]=e,t&&S.proxy.setExpires(S.key,t),v=!0}function I(e,t,r,n){let o;f(e)&&!E&&(o=e.length);let i=e[t],l=f(e)&&y(t)?Number(t)<e.length:h(e,t),a=Reflect.set(e,t,r,n);return a&&d(r,i)&&(l?_(e,t,r,i):_(e,t,r,void 0),f(e)&&void 0!==o&&Number(t)>=o&&_(e,"length",e.length,o),j(e)),a}function D(e,t){let r=h(e,t),n=e[t],o=Reflect.deleteProperty(e,t);return o&&r&&(_(e,t,void 0,n),j(e)),o}function N(e){let t=new Proxy(e,{get:$,set:I,deleteProperty:D});return x.set(t,e),t}let P={String:{read:e=>e,write:e=>e},Number:{read:e=>Number.parseFloat(e),write:e=>String(e)},BigInt:{read:e=>BigInt(e),write:e=>String(e)},Boolean:{read:e=>"true"===e,write:e=>String(e)},Null:{read:()=>null,write:e=>String(e)},Undefined:{read:()=>void 0,write:e=>String(e)},Object:{read:e=>N(e),write:e=>e},Array:{read:e=>N(e),write:e=>e},Set:{read:e=>new Set(e),write:e=>Array.from(e)},Map:{read:e=>new Map(e),write:e=>Array.from(e)},Date:{read:e=>new Date(e),write:e=>String(e)},RegExp:{read:e=>(0,eval)(e),write:e=>String(e)},Function:{read:e=>(0,eval)(`(function() { return ${e} })()`),write:e=>String(e)}};function R(e,t){if(!e)return;let r=e;try{r=w(e)}catch(e){}if(!c(r))return r;if(r.expires&&new Date(+r.expires).getTime()<=Date.now())return void t?.();let n=P[r.type];return n?n.read(r.value):r.value}function M(e,t){let r=g(e),n=P[r];if(!n)throw Error(`can't set "${r}" property.`);let o={type:r,value:n.write(e)};return t&&(o.expires=t),JSON.stringify(o)}function J(e,t,r,n){let o;if((o=u(r)?r.getTime():s(r)?+r.padEnd(13,"0"):r)<=Date.now())return void delete n[t];let i=n[t];if(i)return i=x.get(i)||i,e[`${t}`]=M(i,""+o),new Date(o)}function V(e,t){let r=`${t}`;if(!e[r])return;let n=w(e[r]);if(!(!c(n)||!n.expires||+n.expires<=Date.now()))return new Date(+n.expires)}function A(e,t,r){let n=r[t];n&&(n=x.get(n)||n,e[`${t}`]=M(n))}let W=new Map;function q(e,t,r){v&&(S.storage=e,S.key=t,S.proxy=r);let n=W.get(e);if(n||(n=function(e,t){let r={};["clear","key"].forEach(t=>{r[t]=e[t].bind(e)});let n={getItem:q,setItem:B,setExpires:J,removeExpires:A};Object.keys(n).forEach(o=>{r[o]=function(...r){return n[o](e,...r,t)}});let a={removeItem:F,getExpires:V,off:l,on:o,once:i};return Object.keys(a).forEach(t=>{r[t]=function(...r){return a[t](e,...r)}}),r}(e,r),W.set(e,n)),h(n,t))return Reflect.get(n,t,r);if(!H(e,t))return;let a=`${t}`,f=e[a]||e[t];return f?R(f,b(e,a)):f}function B(e,t,r,n){let o=`${t}`,i=R(e[o],b(e,o));i=x.get(i)||i;let l=Reflect.set(e,o,M(r),n);return l&&d(r,i)&&v&&a(e,t,r,i),l}function H(e,t){return e.hasOwnProperty(`${t}`)||!e.hasOwnProperty(t)&&t in e}function F(e,t){let r=`${t}`,n=h(e,r),o=R(e[r],b(e,r));o=x.get(o)||o;let i=Reflect.deleteProperty(e,r);return i&&n&&a(e,t,void 0,o),i}function T(e){return e?new Proxy(e,{get:q,set:B,has:H,deleteProperty:F}):null}let C="undefined"!=typeof localStorage?localStorage:void 0,L="undefined"!=typeof sessionStorage?sessionStorage:void 0;"undefined"!=typeof window&&window.addEventListener("storage",e=>{if(e.key&&e.key.startsWith("")){let t=e.newValue,r=e.oldValue;e.newValue&&c(t=R(e.newValue,b(C,e.key)))&&(t=x.get(t)||t),e.oldValue&&c(r=R(e.oldValue,b(C,e.key)))&&(r=x.get(r)||r),a(C,e.key.slice(0),t,r)}});let U=T(C),z=T(L),G=e=>{if("string"==typeof e)return{local_key:e,proxy_key:e};{let t=Object.keys(e)[0],r=e[t];return"function"==typeof r?{local_key:t,proxy_key:t,getHandler:r}:"object"==typeof r&&r?{local_key:t,proxy_key:t,fromStorage:r.fromStorage,toStorage:r.toStorage}:{local_key:t,proxy_key:r}}},K=(t,r,n)=>{let o=n?.useSession?z:U;return t.map(t=>{let n=G(t),i=o.getItem(n.local_key);void 0!==i?n.fromStorage?(0,e.set)(r,n.proxy_key,n.fromStorage(i)):n.getHandler?(0,e.set)(r,n.proxy_key,n.getHandler(i)):(0,e.set)(r,n.proxy_key,i):n.toStorage?o.setItem(n.local_key,n.toStorage((0,e.get)(r,n.proxy_key))):o.setItem(n.local_key,(0,e.get)(r,n.proxy_key))}),(0,e.observe)(r,({name:e,newValue:r})=>{t.map(t=>{let n=G(t);e===n.proxy_key&&(n.toStorage?o.setItem(n.local_key,n.toStorage(r)):o.setItem(n.local_key,r))})})},Q=n=>{let o=n.watch,i={},l={},a=[];return Object.keys(o).map(e=>{if(-1!==e.indexOf("|")){let t=e.split("|");a.push(...t.map(t=>({key:t,raw:e})))}-1!==e.indexOf(".")?i[e]=o[e]:l[e]=o[e]}),[...Object.keys(i).map(o=>(0,e.reaction)(()=>(0,r.get)(n,o),(r,n)=>{let l=(0,e.toJS)(r),a=(0,e.toJS)(n);(0,t.deepEqual)(l,a)||i[o](l,a)})),(0,e.observe)(n,i=>{let{name:l,newValue:f,oldValue:u}=i,s=a.find(e=>{if(e.key===l)return e});if(s){let e=s.raw.split("|");e.includes(l)&&o[s.raw](e.map(e=>(0,r.get)(n,e)))}if(o[l]){let r=(0,e.toJS)(f),n=(0,e.toJS)(u);(0,t.deepEqual)(r,n)||o[l](r,n)}})]};export{K as setStorageWhenChange,Q as useInstanceWatch};